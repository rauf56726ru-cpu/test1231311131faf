<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Панель предсказаний</title>
  <link rel="stylesheet" href="/public/styles.css" />
  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="/public/binanceCandles.js" defer></script>
  <script src="/public/chart-gap-watcher.js" defer></script>
</head>
<body
  data-page="predict"
  data-symbol="{{ symbol }}"
  data-interval="{{ interval }}"
  data-model-family="{{ model_family }}"
  data-model-name="{{ model_name }}"
  data-text-embedder="{{ text_embedder }}"
  data-paper="{{ paper }}"
  data-model-status="{{ model_status }}"
  data-job-key="{{ job_key }}"
>
  <header class="predict-header">
    <div class="title-block">
      <h1>Панель предсказаний</h1>
      <div id="model-status-indicator" class="status-indicator" data-status="{{ model_status }}">
        Статус модели: <span id="status-label">{{ model_status }}</span>
      </div>
    </div>

    <div class="control-row">
      <form id="stream-form" class="stream-form">
        <label>
          Тикер
          <input id="input-symbol" name="symbol" type="text" value="{{ symbol }}" required />
        </label>

        <label>
          Интервал
          <select id="input-interval" name="interval">
            {% for value in ["1s", "1m", "3m", "5m", "10m", "15m", "30m", "1h", "4h", "1d"] %}
              <option value="{{ value }}" {% if interval == value %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Семейство
          <select id="input-model-family" name="model_family">
            {% for family in model_families %}
              <option value="{{ family }}" {% if model_family == family %}selected{% endif %}>{{ family }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Версия
          <select id="input-model-name" name="model_name">
            <option value="">latest</option>
            {% for name in model_names %}
              <option value="{{ name }}" {% if model_name == name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Текстовый эмбеддер
          <select id="input-text-embedder" name="text_embedder">
            {% for embedder in allowed_text_models %}
              <option value="{{ embedder }}" {% if text_embedder == embedder %}selected{% endif %}>{{ embedder }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="checkbox">
          <input type="checkbox" id="input-paper" name="paper" value="1" {% if paper %}checked{% endif %} />
          Бумажный режим
        </label>

        <button type="submit" class="btn-primary">Применить</button>
      </form>

      <div class="control-buttons">
        <button id="start-stream" class="btn-primary">Старт</button>
        <button id="stop-stream" class="btn-secondary" disabled>Стоп</button>
        <button id="train-now" class="btn-accent">Перетренировать сейчас</button>
        <button id="open-self-train" type="button" class="btn-secondary">Самообучение</button>
        <button id="open-upload-modal" type="button" class="btn-secondary">Загрузить знания</button>
        <button id="open-settings" class="btn-secondary">Настройки</button>
      </div>
    </div>
  </header>

  <main class="predict-main">
    <div class="predict-grid">
      <aside class="panel panel-left" id="state-panel">
        <h2>Текущая позиция</h2>
        <dl class="state-list">
          <div>
            <dt>Время</dt>
            <dd id="state-ts">&mdash;</dd>
          </div>
          <div>
            <dt>Цена</dt>
            <dd id="state-price">&mdash;</dd>
          </div>
          <div>
            <dt>Вероятность роста</dt>
            <dd id="state-prob">&mdash;</dd>
          </div>
          <div>
            <dt>Уверенность</dt>
            <dd id="state-confidence">&mdash;</dd>
          </div>
          <div>
            <dt>Дов. интервал</dt>
            <dd id="state-ci">&mdash;</dd>
          </div>
          <div>
            <dt>Серая зона</dt>
            <dd id="state-grey">&mdash;</dd>
          </div>
          <div>
            <dt>Режим волатильности</dt>
            <dd id="state-regime">&mdash;</dd>
          </div>
          <div>
            <dt>Сигнал</dt>
            <dd id="state-side">&mdash;</dd>
          </div>
          <div>
            <dt>Позиция</dt>
            <dd id="state-position">&mdash;</dd>
          </div>
          <div>
            <dt>PnL</dt>
            <dd id="state-pnl">&mdash;</dd>
          </div>
          <div>
            <dt>Статус модели</dt>
            <dd id="state-model-status">&mdash;</dd>
          </div>
          <div>
            <dt>Версия модели</dt>
            <dd id="state-model-name">&mdash;</dd>
          </div>
        </dl>
        <section>
          <h3>Guard проверки</h3>
          <ul id="state-guards" class="pill-list"></ul>
        </section>
      </aside>

      <section class="panel panel-center">
        <div id="model-status-banner" class="status-banner hidden"></div>

        <section class="chart-section">
          <div class="chart-toolbar">
            <div class="chart-timeframes" id="chart-timeframes" data-active="{{ interval }}">
              {% for value in chart_timeframes %}
                <button type="button" class="chart-timeframe" data-interval="{{ value }}">{{ value }}</button>
              {% endfor %}
            </div>
            <div class="chart-loader hidden" id="chart-loading">
              <span class="loader-spinner"></span>
            </div>
          </div>
          <div class="chart-wrapper">
            <div id="chart" class="chart-area">
              <div id="live-price-indicator" class="live-price-indicator hidden"></div>
              <div id="entry-zone-overlay" class="entry-zone-overlay hidden"></div>
            </div>
            <div class="chart-legend">
              <span class="legend-item">
                <span class="legend-swatch legend-swatch--real-up"></span>
                Реальная свеча ↑
              </span>
              <span class="legend-item">
                <span class="legend-swatch legend-swatch--real-down"></span>
                Реальная свеча ↓
              </span>
              <span class="legend-item">
                <span class="legend-swatch legend-swatch--predict-up"></span>
                Прогноз ↑ (уверенность)
              </span>
              <span class="legend-item">
                <span class="legend-swatch legend-swatch--predict-down"></span>
                Прогноз ↓ (уверенность)
              </span>
              <span class="legend-item">
                <span class="legend-swatch legend-swatch--knowledge"></span>
                Знание (RAG)
              </span>
              <span class="legend-item legend-item--grey">
                Серая зона: <span id="legend-grey-zone">45% – 55%</span>
              </span>
            </div>
          </div>

          <div class="plan-stats">
            <div>Время: <span id="plan-ts">&mdash;</span></div>
            <div>Цена: <span id="plan-price">&mdash;</span></div>
            <div>Вероятность роста: <span id="plan-prob">&mdash;</span></div>
            <div>Уверенность: <span id="plan-conf">&mdash;</span></div>
            <div>Серая зона: <span id="plan-grey">&mdash;</span></div>
            <div>Дов. интервал: <span id="plan-ci">&mdash;</span></div>
            <div>Сигнал: <span id="plan-side">flat</span></div>
            <div>Цель: <span id="plan-target">&mdash;</span></div>
            <div>Зона входа: <span id="plan-zone">&mdash;</span></div>
            <div>Стоп: <span id="plan-stop">&mdash;</span></div>
            <div>RR: <span id="plan-rr">&mdash;</span></div>
          </div>
        </section>
      </section>

      <aside class="info-panels">
        <section class="panel" id="jobs-panel">
          <h2>Статус джобов</h2>
          <ul id="jobs-list"></ul>
        </section>
        <section class="panel">
          <h2>Активные правила</h2>
          <ul id="rules-list" class="rule-list"></ul>
        </section>
        <section class="panel">
          <h2>Паттерны</h2>
          <ul id="pattern-list" class="pattern-list"></ul>
        </section>
        <section class="panel">
          <h2>Memory hits</h2>
          <div id="memory-hits" class="memory-hits"></div>
        </section>
        <section class="panel log-panel resizable">
          <div class="panel-header">
            <h2>Стрим</h2>
            <div class="log-actions">
              <button type="button" id="log-copy" class="btn-tertiary">Копировать всё</button>
              <button type="button" id="log-clear" class="btn-tertiary">Очистить</button>
            </div>
          </div>
          <div id="stream-log" class="log-content"></div>
        </section>
      </aside>
    </div>

    <div id="upload-status" class="upload-status"></div>
  </main>

  <div id="upload-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="upload-modal-title">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2 id="upload-modal-title">Загрузка знаний</h2>
      <form id="upload-form" class="modal-form">
        <label class="form-field">
          <span>Папка-источник</span>
          <div class="source-picker">
            <input type="text" id="upload-source-path" placeholder="Выберите папку или введите путь" />
            <button type="button" id="upload-source-browse" class="btn-secondary">Выбрать</button>
            <input type="file" id="upload-source-input" class="hidden" webkitdirectory directory multiple />
          </div>
        </label>
        <label class="form-field">
          <span>Имя папки в notion_export</span>
          <input type="text" id="upload-export-name" placeholder="notion_%Y%m%d" required />
        </label>
        <div class="modal-footer">
          <p id="upload-modal-error" class="form-error hidden"></p>
          <div class="modal-actions">
            <button type="button" id="upload-cancel" class="btn-secondary">Отмена</button>
            <button type="submit" id="upload-submit" class="btn-primary" disabled>Загрузить</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div
    id="self-train-modal"
    class="modal hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="self-train-modal-title"
  >
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-content--wide">
      <h2 id="self-train-modal-title">Самообучение</h2>
      <form id="self-train-form" class="modal-form">
        <div class="form-grid">
          <label class="form-field">
            <span>Дата начала</span>
            <input type="date" name="date_from" value="2022-01-01" />
          </label>
          <label class="form-field">
            <span>Дата окончания</span>
            <input type="date" name="date_to" />
          </label>
          <label class="form-field checkbox-inline">
            <input type="checkbox" name="resume" value="1" checked />
            <span>Продолжать с последнего дня</span>
          </label>
        </div>
        <p class="form-hint">Таймфреймы по умолчанию: 5m · 10m · 30m · 1h · 4h · 1d</p>
        <fieldset class="symbol-grid">
          <legend>Символы</legend>
          <label>
            <input type="checkbox" name="self-train-symbols" value="BTCUSDT" checked /> BTCUSDT
          </label>
          <label>
            <input type="checkbox" name="self-train-symbols" value="ETHUSDT" /> ETHUSDT
          </label>
          <label>
            <input type="checkbox" name="self-train-symbols" value="SOLUSDT" /> SOLUSDT
          </label>
        </fieldset>
        <div class="modal-footer">
          <p id="self-train-status" class="form-hint"></p>
          <div class="modal-actions">
            <button type="button" id="self-train-stop" class="btn-secondary">Стоп</button>
            <button type="button" id="self-train-close" class="btn-tertiary">Закрыть</button>
            <button type="submit" class="btn-primary">Старт</button>
          </div>
        </div>
      </form>
      <div class="self-train-progress-wrapper">
        <div class="self-train-live" id="self-train-panel">
          <div class="self-train-live__header">
            <div>
              <span class="self-train-label">Символ</span>
              <span id="self-train-symbol" class="self-train-value">—</span>
            </div>
            <div>
              <span class="self-train-label">День</span>
              <span id="self-train-day" class="self-train-value">—</span>
            </div>
            <div>
              <span class="self-train-label">TF</span>
              <span id="self-train-tf" class="self-train-value">—</span>
            </div>
            <div>
              <span class="self-train-label">Этап</span>
              <span id="self-train-stage" class="self-train-value">idle</span>
            </div>
          </div>
          <div class="self-train-live__metrics">
            <div>
              <span class="self-train-label">Строки</span>
              <span id="self-train-rows" class="self-train-value">0 / 0</span>
            </div>
            <div>
              <span class="self-train-label">MCC</span>
              <span id="self-train-mcc" class="self-train-value">0.00</span>
            </div>
            <div>
              <span class="self-train-label">ECE</span>
              <span id="self-train-ece" class="self-train-value">1.000</span>
            </div>
            <div>
              <span class="self-train-label">SharpeP</span>
              <span id="self-train-sharpe" class="self-train-value">0.00</span>
            </div>
            <div>
              <span class="self-train-label">HitRate</span>
              <span id="self-train-hit" class="self-train-value">0.00</span>
            </div>
            <div>
              <span class="self-train-label">Gate</span>
              <span id="self-train-gate" class="self-train-gate">inactive</span>
            </div>
          </div>
          <div class="self-train-progress">
            <div class="self-train-progress-bar">
              <div class="self-train-progress-bar__inner" id="self-train-progress-bar"></div>
            </div>
            <p id="self-train-progress-text" class="self-train-progress-text">0 / 0 таймфреймов</p>
          </div>
          <div class="self-train-history-list">
            <h3>История</h3>
            <ul id="self-train-history" class="self-train-history"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/public/chart-utils.js" defer></script>
  <script src="/public/app.js" defer></script>
</body>
</html>

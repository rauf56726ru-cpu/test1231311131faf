# Autotrader Prototype

Прототип локальной системы автотрейдинга с числовой моделью, правил-based policy и интеграцией знаний из Notion.

## Возможности
- Потоковый сбор маркет-данных Binance (spot/futures testnet).
- Построение фич и таргетов в Parquet.
- Обучение моделей (XGBoost, TCN) локально.
- Политика принятия решений, управляемая YAML-правилами и RAG-поиском по памяти.
- FAISS-память с материалами из Notion (текст+картинки) и OCR.
- Бэктест с учётом комиссий и проскальзывания, отчёты и метрики.
- Paper-trading цикл и FastAPI для интеграции.

## Быстрый старт
```bash
make venv
make install
cp .env.example .env
# отредактируйте .env при необходимости
make collect SYMBOL=BTCUSDT TF=1m
make build_features
make train_xgb
make backtest CFG=configs/backtest.yaml
make api
```

Дополнительные команды смотрите в [Makefile](Makefile).

## Структура
См. `configs/`, `src/` и `tests/` для ключевых компонентов.

## Документация для новичка

Пошаговый конвейер «свечи → фичи → модель → калибровка → политика → исполнение» описан в [docs/BEGINNER_GUIDE.md](docs/BEGINNER_GUIDE.md).

## Веб-режим

В проект добавлен удобный веб-интерфейс поверх FastAPI.

1. Запустите API: `make api` или `uvicorn src.api.app:app --reload`.
2. Откройте браузер и перейдите на [http://localhost:8000/](http://localhost:8000/).
3. На главной странице выберите тикер, интервал свечей, семейство модели, конкретную версию и текстовый эмбеддер. Нажмите **«Начать»**.
4. Страница `/predict` автоматически откроет WebSocket-поток. Панели отображают текущую свечу, вероятность, сигнал, позицию и сработавшие фильтры.
5. Кнопки **Start/Stop stream** управляют подключением, **Upload knowledge** позволяет загрузить `.zip` или директорию с Markdown/изображениями для пополнения памяти без перезапуска сервера.
6. Нажмите **Change settings**, чтобы поменять модель или эмбеддер «на лету» — UI отправит необходимые запросы и перезапустит поток.

## Артефакты модели

Тренированные модели сохраняются в версионных подпапках `models/<семейство>/<YYYYMMDDHHMMSS>/`.

- **XGB**: `model.pkl` (обязательно), `feature_list.json` (обязательно), `scaler.pkl` (опционально).
- **TCN**: `ckpt.pt`, `feature_list.json`, дополнительные файлы по необходимости.

Папка версии регистрируется в `models/registry.json`, а список доступных моделей на UI формируется по фактически существующим подпапкам.

## Поведение без модели

Если в файловой системе нет валидных артефактов, WebSocket `/ws/predict` продолжает слать свечи и статусы. Поле `model_status` равно `missing`, `prob_up` отсутствует (`null`), а UI выводит уведомление «Модель не найдена. Обучите модель или выберите другую версию.»

## Горячее подключение модели

После обучения (`make train_xgb` и т.п.) новый комплект артефактов автоматически подхватывается без рестарта API или перезагрузки страницы. Следующее обновление потока проставит `model_status="ready"` и начнёт отправлять новые значения `prob_up`.


## Панель предсказаний

Страница `/predict` разворачивает полноценный «терминал»: при первом открытии запускается сбор котировок, подготовка фич, тренировка выбранной модели (XGB или TCN) и инициализируется поток предсказаний. На графике отображаются реальные свечи с белым/чёрным телом, а поверх — зелёный/красный контур прогноза, если уверенность вышла за пределы серой зоны. Боковая панель показывает вероятности, уверенность, доверительный интервал, текущий режим волатильности, активные правила и попадания RAG-памяти. Терминал расширен (≥60vw, 50–70vh), доступна автопрокрутка журнала, кнопки «копировать/очистить», а также модалы для загрузки знаний и запуска самообучения (`/self_train`). Даже в статусе `missing` стрим продолжает отдавать OHLCV, что позволяет наблюдать за ценой до появления модели.

## Автообучение

Менеджер задач автоматически оркестрирует этапы `collect → build_features → train → warmup`. Запуск возможен тремя способами:

- при открытии `/predict` для новой комбинации `{symbol, interval, family}`;
- кнопкой **Перетренировать сейчас** (POST `/train`);
- загрузкой датасета через `/upload`, после чего стартует переобучение с актуальными параметрами панели.

Для каждой тройки действует «охлаждение» (`retrain_cooldown_min` в `configs/settings.yaml`) — повторный запрос вернёт HTTP 202 с текущим `job_id`. Минимальный размер набора (`auto.min_bars_for_train`) контролирует, когда модель может быть переобучена: если данных не хватает, статус возвращается в `collecting`, продолжается сбор свечей и построение новых фич.

## Горячее обновление

После успешной тренировки `ModelCatalog` активирует новую версию и отправляет фронту SSE-событие `model_reloaded`. WebSocket-поток без разрыва переключается на свежие артефакты, статус меняется на `ready`, а поле `prob_up` и план входа обновляются «на лету» без перезагрузки страницы.

\n## Candle Cache\nPersisted OHLC snapshots are stored in \data/live/candles.sqlite\. Remove the file if you need a full refresh of historical data.

# Binance Chart Viewer

Проект свёрнут до минимального фронтенда и компактного API, которые отвечают за построение свечного графика и тестовую инспекцию данных, собранных на стороне клиента.

## Возможности
- Загрузка исторических свечей Binance для выбранного тикера и интервала.
- Отрисовка графика на базе Lightweight Charts: свечи, оси, масштабирование, навигация.
- Линия последней цены и краткая сводка по последней свече.
- Автозаполнение пропусков в данных через `ChartGapWatcher`.
- Живое обновление за счёт WebSocket-потока Binance.
- Кнопка «Inspection» формирует снимок текущего состояния свечей и открывает инспекционную панель на основе этих данных.
- REST-эндпоинты `/inspection/snapshot` и `/inspection`, работающие со снимками данных, без дополнительных запросов к внешним сервисам.

## Как запустить
1. Запустите приложение FastAPI, которое теперь также обслуживает фронтенд-график и статические файлы:
   ```bash
   uvicorn src.api.app:app --reload
   ```
   После запуска откройте в браузере `http://127.0.0.1:8000/` — загрузится страница графика `index.html`.

   Базовые ответы API:
   - `POST /inspection/snapshot` &mdash; принимает снимок с фронтенда и возвращает идентификатор `snapshot_id`:
   ```json
   { "snapshot_id": "snap-1711459200000-a1b2c3" }
   ```
   - `GET /inspection?snapshot=<ID>` &mdash; отдаёт HTML-дашборд. Для JSON-версии запросите с заголовком `Accept: application/json`:
   ```json
   {
     "DATA": {
       "ohlcv": {"symbol": "BTCUSDT", "tf": "1m", "candles": [...]},
       "meta": {"requested": {"symbol": "BTCUSDT", "tf": "1m"}}
     },
     "DIAGNOSTICS": {
       "snapshot_id": "snap-1711459200000-a1b2c3",
       "generated_at": "2024-03-26T12:00:00Z"
     }
   }
   ```
2. Введите тикер (например, `BTCUSDT`) и выберите интервал свечей. График автоматически загрузит историю и переключится в режим реального времени.

## Структура
- `public/` &mdash; JS/стили для графика (`app.js`, `binanceCandles.js`, `chart-gap-watcher.js`, `styles.css`).
- `templates/index.html` &mdash; единственная страница с графиком и панелью управления.
- `src/` &mdash; минимальный FastAPI-проект с обработчиками `/inspection/snapshot`, `/inspection`, `health`, `version` и вспомогательными модулями `services/`.

## Профиль объёма и TPO

Эндпоинт `/profile` возвращает рассчитанный профиль объёма и уровни VAH/VAL/POC для последних торговых сессий.

```http
GET /profile?snapshot=<SNAPSHOT_ID>&tf=1m&last_n=3&adaptive_bins=false&value_area_pct=0.7
```

Параметры запроса:

- `snapshot` — обязательный идентификатор ранее сохранённого снапшота.
- `tf` — таймфрейм, по умолчанию `1m`.
- `last_n` — количество последних сессий (1–5, по умолчанию 3).
- `tick_size` — фиксированный шаг цены, если известен.
- `adaptive_bins` — переключает адаптивный расчёт шага бина (0.5 × ATR), когда `tick_size` не задан.
- `value_area_pct` — доля объёма в value area (по умолчанию 0.7).

Пример ответа:

```json
{
  "symbol": "BTCUSDT",
  "tf": "1m",
  "tpo": [
    {"date": "2024-05-12", "session": "asia", "POC": 61050.0, "VAL": 60920.0, "VAH": 61200.0},
    {"date": "2024-05-12", "session": "london", "POC": 61310.0, "VAH": 61420.0, "VAL": 61210.0}
  ],
  "profile": [
    {"price": 61200.0, "volume": 15.2},
    {"price": 61250.0, "volume": 18.7}
  ],
  "zones": [
    {
      "type": "tpo_poc",
      "price": 61310.0,
      "date": "2024-05-12",
      "session": "london",
      "tf": "1m",
      "meta": {"value_area_pct": 0.7, "source": "tpo"}
    },
    {"type": "tpo_vah", "price": 61420.0, "date": "2024-05-12", "session": "london", "tf": "1m", "meta": {"value_area_pct": 0.7, "source": "tpo"}}
  ],
  "preset": {
    "symbol": "BTCUSDT",
    "tf": "1m",
    "last_n": 3,
    "value_area_pct": 0.7,
    "binning": {"mode": "adaptive", "tick_size": null, "atr_multiplier": 0.5, "target_bins": 80},
    "extras": {"clip_low_volume_tail": 0.005, "smooth_window": 1},
    "builtin": true
  },
  "preset_required": false
}
```

Секция `tpo` содержит сводку по последним сессиям, `profile` — дискретный профиль объёма для самой свежей сессии, а `zones` включает уровни POC/VAH/VAL в формате, совместимом с остальными провайдерами зон.

### Система пресетов TPO

Расчёт профиля управляется пресетами:

- Для популярных инструментов `BTCUSDT`, `ETHUSDT` и `SOLUSDT` встроены дефолтные пресеты (адаптивный биннинг 0.5 × ATR, `last_n=3`, `value_area_pct=0.7`). Они применяются автоматически, а интерфейс отображает компактный бейдж «Preset: SYMBOL».
- Для новых символов пресет настраивается один раз через модальное окно на странице `/inspection`. Введённые параметры сохраняются локально и применяются автоматически при следующих обращениях.
- Перед запуском «check all datas» пресет уже определён (встроенный или пользовательский), а рассчитанные уровни TPO добавляются в массив `zones` основного ответа.

Доступные REST-эндпоинты для управления пресетами:

- `GET /presets` — список доступных пресетов (встроенные + пользовательские).
- `GET /presets/{symbol}` — пресет для конкретного символа (или `null`, если пользовательский ещё не создан).
- `POST /presets` — создание/сохранение пресета (`symbol` обязателен).
- `PUT /presets/{symbol}` — частичное обновление существующего пресета.
- `DELETE /presets/{symbol}` — удаление пользовательского пресета (встроенные остаются доступными).

Все пользовательские пресеты сохраняются в локальном JSON (`var/presets.json`) и кэшируются в памяти для быстрого доступа. Сервер валидирует параметры (`last_n` ∈ [1..5], `value_area_pct` ∈ (0,1), ограничения для биннинга и дополнительных опций) и корректирует их при необходимости.
